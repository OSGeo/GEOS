This commit is the result of a collaborative work between
Mateusz ≈Åoskot and Paul Ramsey. It ended up being squashed
into a single commit so detailed attribution was lost.
